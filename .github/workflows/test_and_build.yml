name: Cross-Platform Test & Build

on:
  push:
    branches: [ "main" ]  # 当代码推送到 main 分支时触发
  pull_request:
    branches: [ "main" ]

jobs:
  test-on-mac:
    # 运行在最新的 macOS 环境中（针对 Mac 用户群）
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # 自动缓存依赖，加快下次运行速度

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Explicitly install PyQt5 related system dependencies on Linux if needed, 
          # but here we are on macOS/Windows.
          # For headless testing of PyQt5, we might need:
          # pip install pytest-qt

      - name: Create Test File
        run: |
          # Generate the test docx file so the test_core.py can use it
          python create_test_docx.py

      - name: Run Unit Tests
        run: |
          # 运行测试脚本
          # Note: PyQt5 GUI tests require a display. In CI, we often skip GUI tests 
          # or use xvfb on Linux. On Mac/Windows runners, it might fail if we try to show windows.
          # For now, we only test core logic.
          python -m pytest tests/test_core.py -v

      - name: Build Application with PyInstaller
        run: |
          pip install pyinstaller
          # Build the PyQt5 application
          # --noconsole: Hide terminal window
          # --onefile: Bundle into single executable
          # --name: Name of the output file
          # --add-data: Include core folder and models (if necessary, though models are large)
          # Note: We exclude models from the bundle to keep it small, they should be downloaded on first run.
          # We need to ensure 'core' package is included.
          pyinstaller --noconsole --onefile --name "SearchingApp" --add-data "core:core" main_ui_qt.py

  test-on-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Test File
        run: |
          python create_test_docx.py

      - name: Run Unit Tests
        run: |
          python -m pytest tests/test_core.py -v

      - name: Build Application with PyInstaller
        run: |
          pip install pyinstaller
          # Windows separator for add-data is ;
          pyinstaller --noconsole --onefile --name "SearchingApp" --add-data "core;core" main_ui_qt.py